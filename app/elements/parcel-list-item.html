<dom-module id="parcel-list-item">
  <template>
    <style>
      :host {
        display: block;
      }
      #expand {
        display:block;
        padding: 5px;
        cursor: pointer;

        transition: transform 300ms linear;
        -webkit-transition: transform 300ms linear;
        -ms-transition: transform 300ms linear;
        -moz-transition: transform 300ms linear;

        transform : rotate(0);
        -webkit-transform : rotate(0);
        -ms-transform : rotate(0);
        -moz-transform : rotate(0);
      }
      #expand.open {
        transform : rotate(90deg);
        -webkit-transform : rotate(90deg);
        -ms-transform : rotate(90deg);
        -moz-transform : rotate(90deg);
      }
      .nlabel {
        font-weight: bold;
      }
    </style>

    <h5>
      <div id="name"></div>
      <div id="inner" ></div>
    </h5>

    <div id="details" >
      <table class="table">
        <tr>
          <td class="nlabel">Parcel Size:</td>
          <td><span id="size"></span> acres</td>
        </tr>
        <tr>
          <td class="nlabel">% Size Available:</td>
          <td><span id="potential"></span>% (<span id="asize"></span>) acres</td>
        </tr>
        <tr>
          <td class="nlabel">Duration</td>
          <td id="duration"></td>
        </tr>
        <tr>
          <td class="nlabel">Current Crops</td>
          <td id="crops"></td>
        </tr>
        <tr>
          <td class="nlabel">Poplar</td>
          <td id="poplar"></td>
        </tr>
      </table>
    </div>

    <h4>Revenue / Acre</h4>
    <div id="revenueChart"></div>

    <h4>Yield / Acre</h4>
    <div id="yieldChart"></div>




  </template>
  <script>
    Polymer({
      is: 'parcel-list-item',

      properties : {
        parcel : {
          type : Object,
          observer : 'onParcelUpdate'
        },
        parcelId : {
          type : String,
          reflectToAttribute : true
        }
      },

      onParcelUpdate : function() {
        if( !this.parcel ) return;
        this.parcelId = this.parcel.properties.PolyID;

        var name = ['Parcel ID: '+this.parcel.properties.PolyID];
        if( this.parcel.properties.SiteAddressFull && this.parcel.properties.SiteAddressFull.trim() ) {
          name.push(this.parcel.properties.SiteAddressFull);
        }
        if( this.parcel.properties.Township && this.parcel.properties.Township.trim() ) {
          name.push(this.parcel.properties.Township);
        }
        this.$.name.innerHTML = name.join(', ');

        this.$.size.innerHTML = Math.round(this.parcel.properties.GISAcres);
        this.$.potential.innerHTML = Math.floor(this.parcel.properties.PotentiallySuitPctOfParcel*100);
        this.$.asize.innerHTML = Math.round(this.parcel.properties.GISAcres * this.parcel.properties.PotentiallySuitPctOfParcel);

        if( this.parcel.properties.ucd && this.parcel.properties.ucd.modelProfileId ) {
          this.onComplete();
        }
      },

      onComplete : function() {
        if( !this.parcel.properties.ucd.modelProfileId ) return;
        var poplarTotal = this.parcel.properties.ucd.harvest.totalHarvest * DSSDK.app.getPoplarPrice();

        var label = 'success';
        if( poplarTotal < this.parcel.properties.ucd.crop.total ) {
          label = 'primary';
        } else {
          DSSDK.datastore.selectParcel(this.parcel);
        }

        setTimeout(this.updateChart.bind(this), 300);
      },

      updateChart : function() {
        if( !this.parcel.properties.ucd.modelProfileId ) return;

        var dt = new google.visualization.DataTable();
        dt.addColumn('string', 'Year'); // Implicit domain label col.
        dt.addColumn('number', '$ Poplar');
        dt.addColumn({type: 'string', role: 'tooltip'});
        dt.addColumn('number', '$ Current Crop(s)');
        dt.addColumn({type: 'string', role: 'tooltip'});

        var id = this.parcel.properties.ucd.modelProfileId;
        var poplarConfig = DSSDK.model.profiles[id].config;
        if( !id ) return;
        var d = new Date(poplarConfig.manage.dateCoppiced.getTime());
        var startYear = d.getFullYear();

        var data = [];
//        var price = DSSDK.app.getPoplarPrice();
        var c = 1;

        var revenueResults = this.parcel.properties.ucd.revenueResults;
        var pR = 0;
        var cR = 0;
        var transportationAvg = 0;
        var tc = 0;

        for( var i = 0; i < revenueResults.poplar.length; i++ ) {
          pR += revenueResults.poplar[i].revenue;
          cR += revenueResults.crops[i].revenue;

          data.push([
            d.getFullYear()+'',
            pR,
            '$'+pR.toFixed(2),
            cR,
            '$'+cR.toFixed(2)
          ]);
          d.setFullYear(d.getFullYear()+1);

          if( revenueResults.poplar[i].transportation ) {
            transportationAvg += revenueResults.poplar[i].transportation;
            tc++;
          }

        }

        if( tc > 0 ) {
          transportationAvg  = transportationAvg / tc;
        }


        dt.addRows(data);
        this.$.duration.innerHTML = (d.getFullYear()-startYear)+' Years';

        var html = '';
        var cropInfo = this.parcel.properties.ucd.cropInfo;
        for( var i = 0; i < cropInfo.swap.length; i++ ) {
          html += '<b>'+cropInfo.swap[i] + '</b><br />'+
          '&nbsp;&nbsp;<b>Cost:</b> $'+cropInfo.cropBudgets[i].budget.total.toFixed(2)+' / Acre - <a href="http://farmbudgets.org/#' +
          cropInfo.cropBudgets[i].id+'" target="_blank"><i class="fa fa-list-alt"></i> Budget Details</a><br />' +
          '&nbsp;&nbsp;<b>Price:</b> '+cropInfo.priceYield[i].price.price+' '+cropInfo.priceYield[i].price.unit+'<br />'+
          '&nbsp;&nbsp;<b>Yield:</b> '+(cropInfo.priceYield[i].yield.yield)+' '+cropInfo.priceYield[i].yield.unit;
        }
        this.$.crops.innerHTML = html;

        if( this.parcel.properties.ucd.harvest.growthError ) {
          this.$.poplar.innerHTML = '<div class="alert alert-danger"><i class="fa fa-warning"></i> Failed to grow poplar :(</div>';
        } else {
          this.$.poplar.innerHTML =
                  '<b>Cost:</b> $'+DSSDK.datastore.getPoplarTotal().toFixed(2)+' / Acre ' +
                  ' - <a href="http://farmbudgets.org/#'+DSSDK.budget.getPoplarBudget().getId()+'" target="_blank"><i class="fa fa-list-alt"></i> Budget Details</a></a><br />' +
                  '<b>Price:</b> $'+DSSDK.datastore.poplarPrice+' / Mg<br />'+
                  '<b>Avg Transportation Cost:</b> $'+transportationAvg.toFixed()+' / Harvest <br />'+
                  '<b>Distance:</b> '+(this.parcel.properties.ucd.transportation.properties.distance*0.621371).toFixed(2)+' mi';
        }

        var options = {
          width : $(this.$.revenueChart).parent().width(),
          height: 300,
          legend : {
            position: 'top'
          },
          hAxis : {
            slantedText:true,
            slantedTextAngle:45
          }
        };
        var chart = new google.visualization.LineChart(this.$.revenueChart);
        chart.draw(dt, options);

        setTimeout(function(){
          options.width = $(this.$.chart).parent().width();
          var chart = new google.visualization.LineChart(this.$.revenueChart);
          chart.draw(dt, options);
        }.bind(this), 500);

        this.updateYieldChart();
      },

      updateYieldChart : function() {
        var dt = new google.visualization.DataTable();
        dt.addColumn('string', 'Year'); // Implicit domain label col.
        dt.addColumn('number', 'Poplar (Mg / Acre)');
        dt.addColumn({type: 'string', role: 'tooltip'});


        var id = this.parcel.properties.ucd.modelProfileId;
        var poplarConfig = DSSDK.model.profiles[id].config;
        if( !id ) return;

        var d = new Date(poplarConfig.manage.dateCoppiced.getTime());
        var startYear = d.getFullYear();

        var data = [];
        var c = 1;

        var revenueResults = this.parcel.properties.ucd.revenueResults;


        var crops = [];
        var included = {};
        for( var i = 0; i < revenueResults.crops.length; i++ ) {
          var yearData = revenueResults.crops[i].breakdown;
          for( var j = 0; j < yearData.length; j++ ) {
            if( !included[yearData[j].crop] ) {
              crops.push({
                crop : yearData[j].crop,
                units : yearData[j].yieldUnits
              });
              included[yearData[j].crop] = true;

              dt.addColumn('number', yearData[j].crop+' ('+yearData[j].yieldUnits+')');
              dt.addColumn({type: 'string', role: 'tooltip'});
            }
          }
        }

        for( var i = 0; i < revenueResults.poplar.length; i++ ) {
          var pyield = 0;
          for( var j = 0; j < revenueResults.poplar[i].breakdown.length; j++ ) {
            pyield += revenueResults.poplar[i].breakdown[j].yield;
          }

          var rowdata = [
            d.getFullYear()+'',
            pyield,
            pyield.toFixed(2)+' (Mg / Acre)'
          ];

          var cyield = 0;
          for( var j = 0; j < revenueResults.crops[i].breakdown.length; j++ ) {
            var yearData = revenueResults.crops[i].breakdown;

            crops.forEach(function(cropInfo){
              var d = this.getYearData(cropInfo, yearData);
              rowdata.push(d.yield);
              rowdata.push(d.yield.toFixed(2)+' ('+d.yieldUnits+')');
            }.bind(this));
          }

          data.push(rowdata);
          d.setFullYear(d.getFullYear()+1);
        }

        dt.addRows(data);

        var options = {
          width : $(this.$.yieldChart).parent().width(),
          height: 300,
          legend : {
            position: 'top'
          },
          hAxis : {
            slantedText:true,
            slantedTextAngle:45
          }
        };
        var chart = new google.visualization.ColumnChart(this.$.yieldChart);
        chart.draw(dt, options);

        setTimeout(function(){
          options.width = $(this.$.chart).parent().width();
          var chart = new google.visualization.ColumnChart(this.$.yieldChart);
          chart.draw(dt, options);
        }.bind(this), 500);
      },

      getYearData : function(cropInfo, yearData) {
        for( var i = 0; i < yearData.length; i++ ) {
          if( yearData[i].crop === cropInfo.crop ) {
            return yearData[i];
          }
        }

        return {
          crop : cropInfo.crop,
          yieldUnits : cropInfo.units,
          yield : 0
        }
      }
    });
  </script>
</dom-module>
