<link rel="import" href="parcel-list-item.html" />

<dom-module id="parcel-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div style="padding:20px; display:none" id="noResults">
      <div class="alert alert-warning">
        <i class="fa fa-warning"></i> You have not selected any parcels. Click 'Select Location' and set your
        biorefinery location first.
      </div>
    </div>

    <template is="dom-repeat" items="{{parcels}}" id="list" initial-count="20">
      <parcel-list-item parcel="{{item}}"></parcel-list-item>
    </template>

  </template>
  <script>
    Polymer({
      is: 'parcel-list',

      ready : function() {
        DSSDK.datastore.on('weather-retrieved', this.onWeatherFound.bind(this));
        DSSDK.datastore.on('soil-retrieved', this.onSoilFound.bind(this));
        DSSDK.model.on('harvests-updated', this.onHarvestUpdated.bind(this));
      },

      onShow : function() {
        if( DSSDK.datastore.parcels.length === 0 ) {
          this.$.noResults.style.display = 'block';
        } else {
          this.$.noResults.style.display = 'none';
        }

        this.update();
      },

      init : function() {
        var eles = this.querySelectorAll('parcel-list-item');
        for( var i = 0; i < eles.length; i++ ) {
          eles[i].init();
        }
      },

      onWeatherFound : function(e) {
        var ele = this.querySelector('parcel-list-item[parcel-id="'+e.id+'"]');
        if( ele ) {
          ele.onWeatherFound();
        }
      },

      onSoilFound : function(e) {
        var ele = this.querySelector('parcel-list-item[parcel-id="'+e.id+'"]');
        if( ele ) {
          ele.onSoilFound();
        }
      },

      onHarvestUpdated : function(e) {
        var ele = this.querySelector('parcel-list-item[parcel-id="'+e.id+'"]');
        if( ele ) {
          ele.onComplete();
        }
      },

      update : function() {
        this.set('parcels', DSSDK.datastore.parcels);
      }
    });
  </script>
</dom-module>
