<dom-module id="results-panel">
  <template>
    <style>
      :host {
        display: block;
      }
      .page-header {
        border-bottom: 1px solid #eee;
      }
    </style>

    <price-yield-popup id="priceYieldPopup" on-yield-price-change="onPriceYieldChange"></price-yield-popup>

    <div style="padding: 0 10px">

    <h4>Overview</h4>

    <table class="table">
      <tr>
        <td style="width: 150px">Price ($ / Mg)</td>
        <td>
          <input type="number" id="poplarPriceInput" class="form-control"  value="24" on-change="onPriceChange" />
        </td>
      </tr>
      <tr>
        <td style="width: 150px">Crop Price/Yield</td>
        <td>
          <a class="btn btn-link" on-click="showPriceYieldPopup">Change</a>
        </td>
      </tr>
      <tr>
        <td>Parcels</td>
        <td id="parcelCount"></td>
      </tr>
      <tr>
        <td>Total Acres</td>
        <td id="acreCount"></td>
      </tr>
      <tr>
        <td>Total Poplar Harvested <span id="runtime"></span>*</td>
        <td id="harvestTotal"></td>
      </tr>
      <tr>
        <td>Average Yearly Poplar Harvest*</td>
        <td id="avgPerYear"></td>
      </tr>
      <tr>
        <td colspan="2"><div class="help-block">*Based on adoption % below.</div></td>
      </tr>
    </table>


    <h4 class="page-header">Adoption <span id="adoptionAmount"></span></h4>


    <div><span id="parcelPercent"></span> All parcels in area adopted.</div>
    <div><span id="validParcelPercent"></span> Competing crop parcels adopted.</div>

    <div id="overviewChart"></div>

    <div id="chart"></div>

    <h4 class="page-header">Adoption By Price</h4>

    <div id="adoptionChart"></div>

    </div>

  </template>
  <script>
    Polymer({
      is: 'results-panel',

      ready : function() {
        this.breakdownRendered = false;
        this.charts = [];
        this.resizeTimer = -1;
        DSSDK.app.setOnCompleteListener(this.update.bind(this));
        $(window).on('resize', this.resize.bind(this));
      },

      resize : function() {
        if( this.resizeTimer !== -1 ) {
          clearTimeout(this.resizeTimer);
        }

        this.resizeTimer = setTimeout(function(){
          this.resizeTimer = -1;
          this._resize();
        }.bind(this), 100);
      },

      _resize : function() {
        var w = $(this).width();
        this.$.chart.style.width = w+'px';
        this.$.adoptionChart.style.width = w+'px';

        this.charts.forEach(function(c){
          c.chart.draw(c.data, c.options);
        });
      },

      onShow : function() {
        this.resize();
      },

      update : function() {
        this.charts = [];
        this.$.parcelPercent.innerHTML = Math.floor(100 * ( DSSDK.datastore.selectedParcels.length / DSSDK.datastore.allParcels.length))+'%';
        this.$.validParcelPercent.innerHTML = Math.floor(100 * ( DSSDK.datastore.selectedParcels.length / DSSDK.datastore.validParcels.length))+'%';
        this.$.parcelCount.innerHTML = DSSDK.datastore.selectedParcels.length;

        var data = [
          ['Parcel Type', 'Parcel Number'],
          ['Adopted', DSSDK.datastore.selectedParcels.length],
          ['Not Adopted', DSSDK.datastore.validParcels.length - DSSDK.datastore.selectedParcels.length]
        ];


        data = google.visualization.arrayToDataTable(data);
        var options = {
          title: 'Adoption of Competing Parcels @ $'+DSSDK.datastore.poplarPrice+' / Mg',
          height: 350
        };
        var chart = new google.visualization.PieChart(this.$.overviewChart);
        chart.draw(data, options);

        this.charts.push({
          chart : chart,
          data : data,
          options: options
        });

        var totalAcres = 0;
        var totalHarvested = 0;
        var years = DSSDK.model.monthsToRun / 12;

        this.$.runtime.innerHTML = '('+years+' Years)';

        var cropCounts = {};

        DSSDK.datastore.selectedParcels.forEach(function(parcel){
          var harvest = parcel.properties.ucd.harvest;
          if( !harvest ) return;

          totalAcres += harvest.growArea;
          totalHarvested += harvest.totalHarvest;

          parcel.properties.ucd.cropInfo.swap.forEach(function(name){
            if( cropCounts[name] === undefined ) {
              cropCounts[name] = 0;
            }
            cropCounts[name]++;
          });
        });

        this.$.acreCount.innerHTML = this.getAmountLabel(totalAcres);
        this.$.harvestTotal.innerHTML = this.getAmountLabel(totalHarvested)+' Mg';
        this.$.avgPerYear.innerHTML = this.getAmountLabel(totalHarvested / years)+' Mg';

        data = [['Crop', 'Parcel Adoption']];
        for( var key in cropCounts ) {
          data.push([key, cropCounts[key]]);
        }

        data = google.visualization.arrayToDataTable(data);
        options = {
          title: 'Adoption By Crop @ $'+DSSDK.datastore.poplarPrice+' / Mg',
          height: 350
        };
        chart = new google.visualization.PieChart(this.$.chart);
        chart.draw(data, options);

        this.charts.push({
          chart : chart,
          data : data,
          options: options
        });

        this.$.adoptionAmount.innerHTML = ' @ $'+DSSDK.datastore.poplarPrice+' / Mg';

        this.updatePriceBreakdown();
      },

      updatePriceBreakdown : function() {
        if( !this.breakdownRendered ) {
          //var breakdown = DSSDK.adoption.breakdown(23, 43, .5);
          this.breakdown = DSSDK.adoption.breakdown(0, 50, 1);
        }
        var breakdown = this.breakdown;


        var dt = new google.visualization.DataTable();

        var data = [];
        var header = ['price'];
        dt.addColumn({id:'price', label: 'Price', type:'number'});

        for( var key in breakdown[0] ) {
          if( key === 'price' ) continue;
          header.push(key);
          dt.addColumn({id:key, label:key, type:'number'});
        }
        dt.addColumn({id:'Current Price', label:'Current Price', type:'number'});
        dt.addColumn({id: 'tooltip', type: 'string', role:'tooltip'});


        var max = 0;
        breakdown.forEach(function(pricedata){
          var row = [];
          for( var i = 0; i < header.length; i++ ) {
            if( i === 0 ) {
              row.push(pricedata[header[i]]);
            } else {
              var count = pricedata[header[i]] ? pricedata[header[i]].parcels : 0;
              row.push(count);
              if( count > max ) {
                max = count;
              }
            }
          }
          row.push(null);
          row.push(null);
          data.push(row);
        });

        // add current line bar
        row = [DSSDK.datastore.poplarPrice];
        for( var i = 1; i < header.length; i++ ) {
          row.push(null);
        }
        row.push(max+20);
        row.push('Current Price: '+DSSDK.datastore.poplarPrice+' $ / Mg');
        data.push(row);

        dt.addRows(data);

        /*var options = {
          title: '',
          height: 400,
          legend : {
            position: 'right'
          },
          hAxis : {
            title: 'Price ($)'
          },
          vAxis : {
            title: 'Parcels (#)'
          }
        };
        var chart = new google.visualization.LineChart(this.$.adoptionChart);*/

        var options = {
          hAxis : {
            title : 'Price ($)'
          },
          height: 400,
          vAxis : {
            title : 'Parcels (#)'
          },
          seriesType: "bars",
          series :{},
          interpolateNulls : true,
          legend : {
            position: 'top'
          }
        }
        var chart = new google.visualization.ComboChart(this.$.adoptionChart);

        for( var i = 0; i < header.length-1; i++ ) {
          options.series[i] = {
            type : 'line',
            targetAxisIndex : 0
          }
        }

        chart.draw(dt, options);

        this.charts.push({
          chart : chart,
          data : dt,
          options: options
        });

        this.breakdownRendered = true;
      },

      getAmountLabel : function(val) {
        val = Math.floor(val)+'';
        return val.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
      },

      onPriceChange : function() {
        DSSDK.app.setPoplarPrice(parseFloat(this.$.poplarPriceInput.value));
      },

      onPriceYieldChange : function(e) {
        e = e.detail;
        DSSDK.datastore.priceYield.currentValues[e.crop][e.type][e.type] = e.value;

        this.breakdownRendered = false;
        DSSDK.app.setPoplarPrice(DSSDK.datastore.poplarPrice);
      },

      setPoplarPrice : function(price) {
        this.$.poplarPriceInput.value = price;
      },

      showPriceYieldPopup : function() {
        this.$.priceYieldPopup.show();
      }
    });
  </script>
</dom-module>
