<dom-module id="model-run-console">
  <template>
    <style>
      :host {
        display: none;
        border: 1px solid #aaa;
        padding: 10px;
        background-color: #333;
        color: white;
      }
    </style>

  </template>
  <script>
    Polymer({
      is: 'model-run-console',

      ready : function() {
        DSSDK.app.runConsole = this;
        this.lines = {};

        DSSDK.datastore.on('transportation-update-start', this.onTransportationStart.bind(this));
        DSSDK.datastore.on('transportation-update-end', this.onTransportationEnd.bind(this));

        DSSDK.datastore.on('weather-update-start', this.onWeatherStart.bind(this));
        DSSDK.datastore.on('weather-update-end', this.onWeatherEnd.bind(this));

        DSSDK.datastore.on('soil-update-start', this.onSoilStart.bind(this));
        DSSDK.datastore.on('soil-update-end', this.onSoilEnd.bind(this));

        DSSDK.datastore.on('parcels-update-start', this.onParcelStart.bind(this));
        DSSDK.datastore.on('parcels-update-updated', this.onParcelUpdated.bind(this));
        DSSDK.datastore.on('parcels-update-end', this.onParcelEnd.bind(this));

        DSSDK.datastore.on('crops-update-start', this.onCropsStart.bind(this));
        DSSDK.datastore.on('crops-update-updated', this.onCropsUpdated.bind(this));
        DSSDK.datastore.on('crops-update-end', this.onCropsEnd.bind(this));

        DSSDK.datastore.on('crop-priceyield-update-start', this.onCropPriceYieldStart.bind(this));
        DSSDK.datastore.on('crop-priceyield-update-end', this.onCropPriceYieldEnd.bind(this));

        DSSDK.datastore.on('budgets-update-start', this.onBudgetsStart.bind(this));
        DSSDK.datastore.on('budgets-update-end', this.onBudgetsEnd.bind(this));

        DSSDK.model.on('harvests-start', this.onHarvestsStart.bind(this));
        DSSDK.model.on('harvests-updated', this.onHarvestsUpdated.bind(this));
        DSSDK.model.on('harvests-end', this.onHarvestsEnd.bind(this));
      },

      onStart : function(lat, lng, radius, socket) {
        this.startTime = new Date().getTime();
        this.innerHTML = '';
        this.style.display = 'block';
        this.createLine('start', 'Starting Model Run @ '+lat.toFixed(4)+', '+lng.toFixed(4)+' Radius: '+(radius/1000)+'km');

        socket.on('transportation-update', this.onTransportationUpdate.bind(this));
      },

      onEnd : function() {
        this.createLine('end', 'Finished. Execution Time: '+((new Date().getTime() - this.startTime) / 1000).toFixed(2)+'s');
      },

      onHarvestsStart : function() {
        this.createLine('harvest', 'Growing Poplar %0','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onHarvestsUpdated : function(e) {
        this.updateLine('harvest', 'Growing Poplar %'+e.percent);
      },

      onHarvestsEnd : function() {
        this.updateLine('harvest', 'Poplar grown','text text-success','<i class="fa fa-check"></i>');
      },

      onParcelStart : function() {
        this.createLine('parcel', 'Finding available parcels','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onParcelUpdated : function(e) {
        this.updateLine('parcel', 'Finding available parcels %'+e.percent);
      },

      onParcelEnd : function(e) {
        this.updateLine('parcel', 'Parcels loaded. '+e.length,'text text-success','<i class="fa fa-check"></i>');
      },

      onTransportationStart : function() {
        this.createLine('transportation', 'Looking up transportation routes %0','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onTransportationUpdate : function(e) {
        this.updateLine('transportation', 'Looking up transportation routes %' +
        e.percent+' (~'+(e.timeRemaining/1000).toFixed(2)+'s @ '+e.averageTime.toFixed(2)+'ms/route)');
      },

      onTransportationEnd : function() {
        this.updateLine('transportation', 'Transportation routes loaded','text text-success','<i class="fa fa-check"></i>');
      },

      onCropsStart : function() {
        this.createLine('crops', 'Looking up crop type for parcels.','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onCropsUpdated : function(e) {
        this.updateLine('crops', 'Looking up crop type for parcels %'+e.percent);
      },

      onCropsEnd : function() {
        var total = DSSDK.datastore.allParcels.length;
        var valid = DSSDK.datastore.validParcels.length;
        this.updateLine('crops', 'Crop type loaded. '+valid+' of '+total+' parcels have competing crops.','text text-success','<i class="fa fa-check"></i>');
      },

      onCropPriceYieldStart : function() {
        this.createLine('cropPriceYield', 'Looking up crop price and yield','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onCropPriceYieldEnd : function() {
        this.updateLine('cropPriceYield', 'Crop price and yield loaded.','text text-success','<i class="fa fa-check"></i>');
      },

      onBudgetsStart : function() {
        this.createLine('budget', 'Looking up farm budgets from farmbudgets.org','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onBudgetsEnd : function() {
        this.updateLine('budget', 'Farm budgets loaded','text text-success','<i class="fa fa-check"></i>');
      },

      onWeatherStart : function() {
        this.createLine('weather', 'Loading weather data','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onWeatherEnd : function() {
        this.updateLine('weather', 'Weather loaded','text text-success','<i class="fa fa-check"></i>');
      },

      onSoilStart : function() {
        this.createLine('soil', 'Loading soil data','text text-warning','<i class="fa fa-spin fa-circle-o-notch"></i>');
      },

      onSoilEnd : function() {
        this.updateLine('soil', 'Soil loaded','text text-success','<i class="fa fa-check"></i>');
      },

      createLine : function(id, msg, className, icon) {
        var line = document.createElement('module-run-console-line');
        line.setText(msg);
        line.setIcon(icon);
        if( className !== undefined ) {
          line.className = className;
        }


        this.lines[id] = line;
        this.appendChild(line);
      },

      updateLine : function(id, msg, className, icon) {
        if( !this.lines[id] ) {
          return;
        }

        var line = this.lines[id];

        line.setText(msg);
        line.setIcon(icon);

        if( className !== undefined ) {
          line.className = className;
        }
      }
    });
  </script>
</dom-module>

<dom-module id="module-run-console-line">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div class="layout horizontal">
      <div id="icon"></div>
      <div id="text" class="flex"></div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'module-run-console-line',

      setText : function(txt) {
        if( txt === undefined ) return;
        this.$.text.innerHTML = txt;
      },

      setIcon : function(icon) {
        if( icon === undefined ) return;
        this.$.icon.style.paddingRight = '15px';
        this.$.icon.innerHTML = icon;
      }

    });
  </script>
</dom-module>
